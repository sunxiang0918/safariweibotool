<!DOCTYPE HTML>
<html>
  <head>
    <meta charset='utf-8' />
    <title>Sina WeiBo Button</title>
<script>
safari.application.addEventListener("command", launchSinaWeiBo, false);
safari.application.addEventListener("message",respondToMessage,false);
safari.application.addEventListener("validate", loadPrefs, false);
//safari.application.addEventListener("validate", validateCommand, false);

function launchSinaWeiBo(event)
{
	 var reload = false;
	 
	 if (safari.extension.toolbarItems[0].image == safari.extension.baseURI+"error.png") {
        reload = true;
    }
	
	var thisTabUrl = safari.application.activeBrowserWindow.activeTab.url;		//获取当前页面的URL
	 
	 /*验证当前页面是否已经是新浪微博的页面了*/
	 if (thisTabUrl && thisTabUrl.match(/^http?:\/\/(.+\.)?weibo\.(.+)\/?/)) {
        safari.application.activeBrowserWindow.activeTab.url = "http://weibo.com/";
        return;
    }

	/*验证已经打开的页面*/
	 if (safari.extension.settings.getItem("useExisting")) {
        var windowTabs = safari.application.activeBrowserWindow.tabs;
        for (var i=0; i<windowTabs.length; i++) {
            if (windowTabs[i].url && windowTabs[i].url.match(/^http?:\/\/(.+\.)?weibo\.(.+)\/(\/.+)?/)) {
                windowTabs[i].activate();
                if (reload) { safari.application.activeBrowserWindow.activeTab.url = "http://weibo.com/"; }
                return;
            }
        }
        var allWindows = safari.application.browserWindows;
        for (var i=0; i<allWindows.length; i++) {
            for (var j=0; j<allWindows[i].tabs.length; j++) {
                if (allWindows[i].tabs[j].url && allWindows[i].tabs[j].url.match(/^http?:\/\/(.+\.)?weibo\.(.+)\/(\/.+)?/)) {
                    allWindows[i].tabs[j].activate();
                    allWindows[i].activate();
                    if (reload) { safari.application.activeBrowserWindow.activeTab.url = "http://weibo.com/"; }
                    return;
                }
            }
        }
    }

	if (safari.application.activeBrowserWindow.activeTab.url) {
        var newTab = safari.application.activeBrowserWindow.openTab();
        newTab.url = "http://weibo.com/";
    } else {
        safari.application.activeBrowserWindow.activeTab.url = "http://weibo.com/";
    }

	// You should always check the command.
	//if (event.command != "weiboButtonAction")
	//	return;
	//alert("hello");
}

function getUnreadCount(){

}

function validateCommand(event)
{
	// You should always check the command.
	if (event.command != "weiboButtonAction")
		return;

	// Disable the target if there are fewer than 2 tabs in the target's window.
	var url= event.target.browserWindow.activeTab.url;
	if(url==null){
		event.target.disabled =true;
	}
}
</script>
 </head>
</html>
