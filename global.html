<!DOCTYPE HTML>
<html>
  <head>
    <meta charset='utf-8' />
    <title>Sina WeiBo Button</title>
    <!--导入jquery-->
    <script src="jquery-1.6.2.min.js"></script>
    <script src="oauth.js"></script>
	<script src="sha1.js"></script>
<script>
safari.application.addEventListener("command", launchSinaWeiBo, false);
//safari.application.addEventListener("validate", loadPrefs, false);


var appId="3192287051";

var unread = -1;			//未读数目
var updater = null;		//循环更新器
var includedItems = "all";		//检测的类型
var lastCheck;		//最后一次检测的时间

function launchSinaWeiBo(event)
{
	oauthValidate();
	 var reload = false;
	 
	 if (safari.extension.toolbarItems[0].image == safari.extension.baseURI+"error.png") {
        reload = true;
    }
	
	var thisTabUrl = safari.application.activeBrowserWindow.activeTab.url;		//获取当前页面的URL
	 
	 /*验证当前页面是否已经是新浪微博的页面了*/
	 if (thisTabUrl && thisTabUrl.match(/^http?:\/\/(.+\.)?weibo\.(.+)\/?/)) {
        safari.application.activeBrowserWindow.activeTab.url = "http://weibo.com/";
        return;
    }

	/*验证已经打开的页面*/
	 if (safari.extension.settings.getItem("useExisting")) {
        var windowTabs = safari.application.activeBrowserWindow.tabs;
        for (var i=0; i<windowTabs.length; i++) {
            if (windowTabs[i].url && windowTabs[i].url.match(/^http?:\/\/(.+\.)?weibo\.(.+)\/(\/.+)?/)) {
                windowTabs[i].activate();
                if (reload) { safari.application.activeBrowserWindow.activeTab.url = "http://weibo.com/"; }
                return;
            }
        }
        var allWindows = safari.application.browserWindows;
        for (var i=0; i<allWindows.length; i++) {
            for (var j=0; j<allWindows[i].tabs.length; j++) {
                if (allWindows[i].tabs[j].url && allWindows[i].tabs[j].url.match(/^http?:\/\/(.+\.)?weibo\.(.+)\/(\/.+)?/)) {
                    allWindows[i].tabs[j].activate();
                    allWindows[i].activate();
                    if (reload) { safari.application.activeBrowserWindow.activeTab.url = "http://weibo.com/"; }
                    return;
                }
            }
        }
    }

	if (safari.application.activeBrowserWindow.activeTab.url) {
        var newTab = safari.application.activeBrowserWindow.openTab();
        newTab.url = "http://weibo.com/";
    } else {
        safari.application.activeBrowserWindow.activeTab.url = "http://weibo.com/";
    }

	// You should always check the command.
	//if (event.command != "weiboButtonAction")
	//	return;
	//alert("hello");
}

function getUnreadCount(){

}

function loadPrefs()
{
    //includedItems = safari.extension.settings.getItem("includedItems");		//获取数量的种类,
    var checkInterval = safari.extension.settings.getItem("checkInterval");		//查询的间隔时间

    if (checkInterval != -1) {
        var now = new Date().getTime();	//现在
        if (!lastCheck || now >= (lastCheck + checkInterval*60*1000)) {		//时间转换为毫秒,并且验证检查时间
            lastCheck = now;
            setRefresh(checkInterval);
        } else {
            var buttons = safari.extension.toolbarItems;
            for (var i=0; i<buttons.length; i++) {
                buttons[i].badge = unread;		//设置未读数目
            }
        }
    }
}

/*重读未读条目*/
function setRefresh(minutes) {
    if (minutes && !isNaN(minutes)) {
        getUnreadCount();
        clearInterval(updater);
        updater = setInterval("getUnreadCount();", (minutes*60*1000));
    } else {
        clearInterval(updater);
        updater = null;
    }
}

/*读取未读的数量*/
function getUnreadCount()
{
	/*
    $.ajax({
		url: "http://api.t.sina.com.cn/statuses/unread.json",
		data:{ source: appId},
		dataType:"json",
		success: function(data, textStatus){
			alert(data);
		},
		error: function(XMLHttpRequest, textStatus){
			
				// 错误,通常是因为没有登陆
                unread = 0;
                var buttons = safari.extension.toolbarItems;
                for (var i=0; i<buttons.length; i++) {
                    buttons[i].badge = 0;
                    buttons[i].image = safari.extension.baseURI+"error.png";
                    buttons[i].toolTip = "获取微博数目错误,有可能是没有登陆造成的,单击按钮登陆";
                }
			
			//alert("in error");
			//alert(XMLHttpRequest.readyState);
			//alert(XMLHttpRequest.status);			//错误代码
			alert(XMLHttpRequest.responseText);		//JSON格式的错误信息 比如 {"request":"/statuses/unread.json","error_code":"403","error":"40302:Error: auth faild!"}
		}
	});*/
}

function oauthValidate()
{

	var oauth_consumer_key="3192287051";
	var app_secret ="4346503e1d8ff6ff21288ee2848a5b24";
	var oauth_nonce=nonce(43);		//获取随机数
	var oauth_timestamp=timestamp();
	var oauth_signature_method="HMAC-SHA1";
	var oauth_version="1.0";
	var request_token_api="http://api.t.sina.com.cn/oauth/request_token";
	var oauth_method="GET";
	
	var param_arr = ["oauth_consumer_key=" + oauth_consumer_key,
                    "oauth_nonce=" + oauth_nonce,
                    "oauth_signature_method=" + oauth_signature_method,
                    "oauth_timestamp=" + oauth_timestamp,
                    "oauth_version=" + oauth_version];
    var base_string = oauth_method + "&" + encodeURIComponent(request_token_api) + "&" + encodeURIComponent(param_arr.join("&"));
    var oauth_signature = b64_hmac_sha1(app_secret + "&", base_string) + "=";
        
     var args = "oauth_consumer_key=" + encodeURIComponent(oauth_consumer_key)
                   + "&oauth_nonce=" + encodeURIComponent(oauth_nonce)
                   + "&oauth_timestamp=" + encodeURIComponent(oauth_timestamp)
                   + "&oauth_signature_method=" + encodeURIComponent(oauth_signature_method)
                   + "&oauth_signature=" + encodeURIComponent(oauth_signature)
                   + "&oauth_version=" + encodeURIComponent(oauth_version);
 	
	$.get('http://api.t.sina.com.cn/oauth/request_token?'+args, function(data) {
			var oauth_token=getParameter("oauth_token",data);			//获取oauth_token
		    var oauth_token_secret=getParameter("oauth_token_secret",data);		//获取oauth_token_secret
	}).error(function(data) { alert("error:"+data.responseText); });
}

/*解析GET变量形式的值*/
function getParameter( val ,data) {
	var re = new RegExp (val + "=([^&#]*)","i")
	var a = re.exec(data)
	if ( a == null )
		return null;
	return decodeURI(a[1]);
};

/*随机生成字符串*/
function nonce(length) {
        var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
        var result = "";
        for (var i = 0; i < length; ++i) {
            var rnum = Math.floor(Math.random() * chars.length);
            result += chars.substring(rnum, rnum+1);
        }
        return result;
}

/*获取时间戳*/
function timestamp() {
        var t = (new Date()).getTime() ;
        return Math.floor(t / 1000);
}

</script>
 </head>

</html>
