<!DOCTYPE HTML>
<html>
  <head>
    <meta charset='utf-8' />
    <title>Sina WeiBo Button</title>
    <!--导入jquery-->
    <script src="jquery-1.6.2.min.js"></script>
    <script src="oauth.js"></script>
	<script src="sha1.js"></script>
<script>
safari.application.addEventListener("command", launchSinaWeiBo, false);
safari.application.addEventListener("validate", loadPrefs, false);

var appId="3192287051";
var app_secret ="4346503e1d8ff6ff21288ee2848a5b24";

var unread = -1;			//未读数目
var updater = null;		//循环更新器
var lastCheck;		//最后一次检测的时间

var oauth_consumer_key=appId;
var oauth_signature_method="HMAC-SHA1";
var oauth_version="1.0";
var oauth_method="GET";

/*按钮的主响应方法*/
function launchSinaWeiBo(event)
{
	 var reload = false;
	 
	 if (safari.extension.toolbarItems[0].image == safari.extension.baseURI+"error.png") {
        reload = true;
		if (safari.extension.settings.oauth_verifier==null||safari.extension.settings.oauth_verifier==""){
			getOauthValidateRequestToken();
		}else{
			getOauthValidateAccessToken	();
		}
    }
	
	var thisTabUrl = safari.application.activeBrowserWindow.activeTab.url;		//获取当前页面的URL
	 
	 /*验证当前页面是否已经是新浪微博的页面了*/
	 if (thisTabUrl && thisTabUrl.match(/^http?:\/\/(.+\.)?weibo\.(.+)\/?/)) {
        safari.application.activeBrowserWindow.activeTab.url = "http://weibo.com/";
        return;
    }

	/*验证已经打开的页面*/
	 if (safari.extension.settings.getItem("useExisting")) {
        var windowTabs = safari.application.activeBrowserWindow.tabs;
        for (var i=0; i<windowTabs.length; i++) {
            if (windowTabs[i].url && windowTabs[i].url.match(/^http?:\/\/(.+\.)?weibo\.(.+)\/(\/.+)?/)) {
                windowTabs[i].activate();
                if (reload) { safari.application.activeBrowserWindow.activeTab.url = "http://weibo.com/"; }
                return;
            }
        }
        var allWindows = safari.application.browserWindows;
        for (var i=0; i<allWindows.length; i++) {
            for (var j=0; j<allWindows[i].tabs.length; j++) {
                if (allWindows[i].tabs[j].url && allWindows[i].tabs[j].url.match(/^http?:\/\/(.+\.)?weibo\.(.+)\/(\/.+)?/)) {
                    allWindows[i].tabs[j].activate();
                    allWindows[i].activate();
                    if (reload) { safari.application.activeBrowserWindow.activeTab.url = "http://weibo.com/"; }
                    return;
                }
            }
        }
    }

	if (safari.application.activeBrowserWindow.activeTab.url) {
        var newTab = safari.application.activeBrowserWindow.openTab();
        newTab.url = "http://weibo.com/";
    } else {
        safari.application.activeBrowserWindow.activeTab.url = "http://weibo.com/";
    }

	// You should always check the command.
	//if (event.command != "weiboButtonAction")
	//	return;
	//alert("hello");
}

function loadPrefs()
{
    //includedItems = safari.extension.settings.getItem("includedItems");		//获取数量的种类,
    var checkInterval = safari.extension.settings.getItem("checkInterval");		//查询的间隔时间

    if (checkInterval != -1) {
        var now = new Date().getTime();	//现在
        if (!lastCheck || now >= (lastCheck + checkInterval*60*1000)) {		//时间转换为毫秒,并且验证检查时间
            lastCheck = now;
            setRefresh(checkInterval);
        } else {
            var buttons = safari.extension.toolbarItems;
            for (var i=0; i<buttons.length; i++) {
                buttons[i].badge = unread;		//设置未读数目
            }
        }
    }
}

/*重读未读条目*/
function setRefresh(minutes) {
    if (minutes && !isNaN(minutes)) {
        getUnreadCount();
        clearInterval(updater);
        updater = setInterval("getUnreadCount();", (minutes*60*1000));
    } else {
        clearInterval(updater);
        updater = null;
    }
}

/*读取未读的数量*/
function getUnreadCount()
{
	if(safari.extension.settings.oauth_verifier==null||safari.extension.settings.oauth_verifier==""||safari.extension.settings.access_token==null||safari.extension.settings.access_token==""){
			setButtonError();
			return;
	}
	
	var oauth_nonce=nonce(43);		//获取随机数
	var oauth_timestamp=timestamp();
	var request_token_api="http://api.t.sina.com.cn/statuses/unread.json";
	var param_arr = ["oauth_consumer_key=" + oauth_consumer_key,
                    "oauth_nonce=" + oauth_nonce,
                    "oauth_signature_method=" + oauth_signature_method,
                    "oauth_timestamp=" + oauth_timestamp,
					"oauth_token="+safari.extension.settings.access_token,
                    "oauth_version=" + oauth_version];
    var base_string = oauth_method + "&" + encodeURIComponent(request_token_api) + "&" + encodeURIComponent(param_arr.join("&"));
    var oauth_signature = b64_hmac_sha1(app_secret + "&"+safari.extension.settings.access_token_secret, base_string) + "=";
	
	$.ajax( {
         url : 'http://api.t.sina.com.cn/statuses/unread.json', type : 'GET',
		 data: {  oauth_consumer_key : oauth_consumer_key,
		 			oauth_nonce : oauth_nonce,
		 			oauth_timestamp : oauth_timestamp,
		 			oauth_signature_method :  oauth_signature_method,
					oauth_token :safari.extension.settings.access_token,
		 			oauth_signature : oauth_signature,
				 	oauth_version : oauth_version}, 
		 dataType:"json",
		 success : function(data) {
			 var count=parseInt(data.comments)+parseInt(data.followers)+parseInt(data.dm)+parseInt(data.mentions);
			 setButtonRight(null);
			 setButtonRight(count);
		 },
		error : function(f, e, g) {
			alert("error:"+decodeURIComponent(f.responseText));
			setButtonError();
		}
     });
}

function setButtonError(){
				// 错误,通常是因为没有登陆
                unread = 0;
                var buttons = safari.extension.toolbarItems;
                for (var i=0; i<buttons.length; i++) {
                    buttons[i].badge = 0;
                    buttons[i].image = safari.extension.baseURI+"error.png";
                    buttons[i].toolTip = "获取微博数目错误,有可能是没有登陆造成的,单击按钮登陆";
                }
}

function setButtonRight(count){
   	// 错误,通常是因为没有登陆
				unread=count;
                var buttons = safari.extension.toolbarItems;
                for (var i=0; i<buttons.length; i++) {
					//alert("label:"+buttons[i].label+" unread:"+count);
					if(count == null){
						buttons[i].image = safari.extension.baseURI+"logo.png";
                    	buttons[i].toolTip = "单击按钮打开首页";
					}else{
						buttons[i].badge = count;
					}
                }
}

/*授权第一步,获取requestToken*/
function getOauthValidateRequestToken()
{
	var oauth_nonce=nonce(43);		//获取随机数
	var oauth_timestamp=timestamp();
	var request_token_api="http://api.t.sina.com.cn/oauth/request_token";
	var param_arr = ["oauth_consumer_key=" + oauth_consumer_key,
                    "oauth_nonce=" + oauth_nonce,
                    "oauth_signature_method=" + oauth_signature_method,
                    "oauth_timestamp=" + oauth_timestamp,
                    "oauth_version=" + oauth_version];
    var base_string = oauth_method + "&" + encodeURIComponent(request_token_api) + "&" + encodeURIComponent(param_arr.join("&"));
    var oauth_signature = b64_hmac_sha1(app_secret + "&", base_string) + "=";
	
	$.ajax( {
         url : request_token_api, type : 'GET',
		 data: {  oauth_consumer_key : oauth_consumer_key,
		 			oauth_nonce : oauth_nonce,
		 			oauth_timestamp : oauth_timestamp,
		 			oauth_signature_method :  oauth_signature_method,
		 			oauth_signature : oauth_signature,
				 	oauth_version : oauth_version}, 
		 success : function(data) {
          	var oauth_token=getParameter("oauth_token",data);			//获取oauth_token
		    var oauth_token_secret=getParameter("oauth_token_secret",data);		//获取oauth_token_secret
			openOauthValidateUserLoginPage(oauth_token,oauth_token_secret);		//调用函数进行第二步用户授权的验证
		 },
		error : function(f, e, g) {
			alert("error:"+decodeURIComponent(f.responseText));
		}
     });

}

/*打开用户授权页面,用户获取PIN码*/
function openOauthValidateUserLoginPage(oauth_token,oauth_token_secret){
		safari.extension.settings.oauth_token=oauth_token;
		safari.extension.settings.oauth_token_secret=oauth_token_secret;
		var newTab = safari.application.activeBrowserWindow.openTab();
		newTab.url='http://api.t.sina.com.cn/oauth/authorize?oauth_token='+oauth_token;
}

/*获取用户授权后的 access_token和 access_token_secret*/
function getOauthValidateAccessToken(){
	var oauth_nonce=nonce(43);		//获取随机数
	var oauth_timestamp=timestamp();
	var request_token_api="http://api.t.sina.com.cn/oauth/access_token";
	var oauth_verifier=safari.extension.settings.oauth_verifier;
	var oauth_token=safari.extension.settings.oauth_token;
	var oauth_token_secret=safari.extension.settings.oauth_token_secret;
	var param_arr = ["oauth_consumer_key=" + oauth_consumer_key,
                    "oauth_nonce=" + oauth_nonce,
                    "oauth_signature_method=" + oauth_signature_method,
					"oauth_timestamp=" + oauth_timestamp,
					"oauth_token="+oauth_token,
					"oauth_verifier="+oauth_verifier,
                    "oauth_version=" + oauth_version];
    var base_string = oauth_method + "&" + encodeURIComponent(request_token_api) + "&" + encodeURIComponent(param_arr.join("&"));
    var oauth_signature = b64_hmac_sha1(app_secret + "&"+oauth_token_secret, base_string) + "=";
	
	$.ajax( {
         url : 'http://api.t.sina.com.cn/oauth/access_token', type : 'GET',
		 data: {  oauth_consumer_key : oauth_consumer_key,
		 			oauth_nonce : oauth_nonce,
		 			oauth_timestamp : oauth_timestamp,
		 			oauth_signature_method :  oauth_signature_method,
					oauth_verifier :oauth_verifier,
					oauth_token :oauth_token,
		 			oauth_signature : oauth_signature,
				 	oauth_version : oauth_version}, 
		 success : function(data) {
			 safari.extension.settings.access_token=getParameter("oauth_token",data);			//获取oauth_token
		     safari.extension.settings.access_token_secret=getParameter("oauth_token_secret",data);		//获取oauth_token_secret
			 getUnreadCount();		//马上就再读一次
		 },
		error : function(f, e, g) {
			alert("error:"+decodeURIComponent(f.responseText));
			//TODO 这个地方需要处理验证失败后清除access_token access_token_secret
		}
     });
}

/*解析GET变量形式的值*/
function getParameter( val ,data) {
	var re = new RegExp (val + "=([^&#]*)","i")
	var a = re.exec(data)
	if ( a == null )
		return null;
	return decodeURI(a[1]);
};

/*随机生成字符串*/
function nonce(length) {
        var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
        var result = "";
        for (var i = 0; i < length; ++i) {
            var rnum = Math.floor(Math.random() * chars.length);
            result += chars.substring(rnum, rnum+1);
        }
        return result;
}

/*获取时间戳*/
function timestamp() {
        var t = (new Date()).getTime() ;
        return Math.floor(t / 1000);
}

</script>
 </head>

</html>
